<?php 
namespace GL\Core\Twig;

use GL\Core\Helpers\Utils;
use Symfony\Component\DependencyInjection\ContainerInterface;

/**
 * Add function to Twig
 */
class TwigHelper extends \Twig_Extension
{
  protected $container;   

  public function __construct(ContainerInterface $container = null)
  {
       $this->container = $container;
  }
  
    public function getFunctions()
    {
        return array(
            new \Twig_SimpleFunction('url', array($this,'url'),array('is_safe'=>array('html'))),
            new \Twig_SimpleFunction('crsf', array($this,'crsf'),array('is_safe'=>array('html'))),
            new \Twig_SimpleFunction('getcrsfinput', array($this,'getcrsfinput'),array('is_safe'=>array('html'))),           
        );        
    }
    
    public function getFilters()
    {         
        return array(       
                 new \Twig_SimpleFilter('frenchdate', array($this,'getFrenchDate')), 
                 new \Twig_SimpleFilter('trans', array($this,'trans')),
            );        
    }
    
    /**
     * Function for returning date in french format like Lundi 12 Mai 1999 23:12
     * @param \Datetime $datetime date to convert
     * @param type $lang Conversion language default french
     * @param type $pattern default pattern, french as default value
     * @return string
     */
    public function getFrenchDate(\Datetime $datetime, $lang = 'fr_FR', $pattern = 'E dd MMM yyyy HH:mm ')
    {
            $formatter = new \IntlDateFormatter($lang, \IntlDateFormatter::LONG, \IntlDateFormatter::LONG);
            $formatter->setPattern($pattern);
            return $formatter->format($datetime);
    }

    /**
     * Get translation
     * 
     * @param string $text tag to find in local file translation
     * @param string $locale locale provided by config.yml
     * @return string string found in lang/{locale}.yml
     */
    public function trans($text,$locale = LOCALE)
    {

        $trans = $this->container->get('translator');
        if($locale!=LOCALE){$trans->setLocale($locale);}
        $session = $this->container->get('session');
        if($session->get('twig.locale')!="")
        {
            if($trans->getLocale()!=$session->get('twig.locale')){$trans->setLocale($session->get('twig.locale'));}
        }        
        return $trans->translate($text);
    }
        
    /**
     * Convert relative url to absolute url
     * 
     * @param string $partialurl relative url
     * @return string absolute url (use BASE_PATH define in config.php)
     */
    public function url($partialurl)
    {
        return Utils::url($partialurl);        
    }
    
    /**
     * Get Actual Token
     * 
     * @return string Actual Crsf Token
     */
    public function crsf()
    {
        $token = "";
        if($this->container!=null)
        {
            $crsf = $this->container->get('crsf');
            if($crsf!=null)
            {
                $token = $crsf->GetToken();
                if($token==null || $token=="")
                {
                    $token = $crsf->InitCrsf();
                }                 
            }
        }
        return $token;
    }
    
    /**
     * Return Html Input with Crsf token
     * 
     * @param string $inputname form input name
     * @return string Html Input Hidden type
     */
    public function getcrsfinput($inputname='crsftoken')
    {
        $token = "";
        if($this->container!=null)
        {
            $crsf = $this->container->get('crsf');
            if($crsf!=null)
            {
                $token = $crsf->GetToken();
                if($token==null || $token=="")
                {
                    $token = $crsf->InitCrsf();
                }                 
            }
        }
        $html = "<!-- autogenerated element --><input type='hidden' value='".$token."' name='".$inputname."' id='".$inputname."'>";
        return $html;
    }
    
    public function getName()
    {
        return 'TwigHelper';
    }

}